name: Dependency Update Check

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check for Maven dependency updates
        run: |
          ./build/mvn versions:display-dependency-updates > dependency-updates.txt
          ./build/mvn versions:display-plugin-updates >> dependency-updates.txt
          cat dependency-updates.txt

      - name: Create issue if updates available
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const updates = fs.readFileSync('dependency-updates.txt', 'utf8');
            
            if (updates.includes('The following dependencies in Dependencies have newer versions:') ||
                updates.includes('The following plugin updates are available:')) {
              
              const issueTitle = 'Dependency Updates Available - ' + new Date().toISOString().split('T')[0];
              const issueBody = `## Dependency Update Check\n\nAutomated check found available updates:\n\n\`\`\`\n${updates}\n\`\`\`\n\nPlease review and update as appropriate.`;
              
              // Check if similar issue already exists
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependencies'
              });
              
              const existingIssue = issues.data.find(issue => 
                issue.title.startsWith('Dependency Updates Available')
              );
              
              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['dependencies', 'automated']
                });
                console.log('Created new issue for dependency updates');
              } else {
                console.log('Issue already exists, skipping creation');
              }
            } else {
              console.log('No updates found');
            }

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates
          path: dependency-updates.txt
          retention-days: 30

